import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go

# ---------------------------------------------------------
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
# ---------------------------------------------------------
st.set_page_config(
    page_title="My AI Portfolio Tracker",
    page_icon="üöÄ",
    layout="wide"
)

st.title("üöÄ My Grand Portfolio Tracker")
st.markdown("‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á **AMZN, V, NVDA, LLY, WBD, TSM** ‡πÅ‡∏ö‡∏ö Real-time")
st.markdown("---")

# ---------------------------------------------------------
# 2. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
# ---------------------------------------------------------
my_stocks = ['AMZN', 'V', 'NVDA', 'LLY', 'WBD', 'TSM']

# ---------------------------------------------------------
# 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß)
# ---------------------------------------------------------
@st.cache_data
def get_stock_data(tickers):
    data = {}
    for symbol in tickers:
        stock = yf.Ticker(symbol)
        # ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        hist = stock.history(period="6mo")
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
        info = stock.info
        data[symbol] = {
            'history': hist,
            'current_price': info.get('currentPrice', hist['Close'].iloc[-1]),
            'prev_close': info.get('previousClose', hist['Close'].iloc[-2]),
            'name': info.get('shortName', symbol)
        }
    return data

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 2-3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...'):
    stock_data = get_stock_data(my_stocks)

# ---------------------------------------------------------
# 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô Card ‡∏™‡∏ß‡∏¢‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
# ---------------------------------------------------------
cols = st.columns(len(my_stocks)) # ‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô

for i, symbol in enumerate(my_stocks):
    info = stock_data[symbol]
    price = info['current_price']
    prev = info['prev_close']
    change = price - prev
    pct_change = (change / prev) * 100
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß=‡∏Ç‡∏∂‡πâ‡∏ô, ‡πÅ‡∏î‡∏á=‡∏•‡∏á)
    color = "green" if change >= 0 else "red"
    
    with cols[i]:
        st.metric(
            label=symbol,
            value=f"${price:.2f}",
            delta=f"{pct_change:.2f}%"
        )

st.markdown("---")

# ---------------------------------------------------------
# 5. ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
# ---------------------------------------------------------
st.subheader("üìà Price Trend Analysis")

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü
selected_stock = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:", my_stocks)

if selected_stock:
    df = stock_data[selected_stock]['history']
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢ Plotly
    fig = go.Figure()
    
    # ‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î
    fig.add_trace(go.Scatter(
        x=df.index, 
        y=df['Close'], 
        mode='lines', 
        name='Close Price',
        line=dict(color='#00C9FF', width=2)
    ))
    
    fig.update_layout(
        title=f"‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ {selected_stock} (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)",
        xaxis_title="Date",
        yaxis_title="Price (USD)",
        template="plotly_dark",
        height=500
    )
    
    st.plotly_chart(fig, use_container_width=True)

# ---------------------------------------------------------
# 6. ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ (Footer)
# ---------------------------------------------------------
st.markdown("---")
st.caption("Auto-generated by Gemini Assistant | Data source: Yahoo Finance")